<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†é¢æ¿ - è±ç‰ çƒè¡£ç™»è¨˜ç³»çµ±</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }

    /* Loading state */
    .loading-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      flex-direction: column;
      gap: 20px;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(102, 126, 234, 0.2);
      border-radius: 50%;
      border-top-color: #667eea;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: #6c757d;
      font-size: 16px;
    }

    /* Main container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      display: none;
    }

    .container.show {
      display: block;
    }

    /* Header */
    .admin-header {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-title h1 {
      margin: 0;
      font-size: 28px;
      color: #2c3e50;
      font-weight: bold;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
      color: #6c757d;
      font-size: 14px;
    }

    .user-email {
      font-weight: 500;
      color: #495057;
    }

    .logout-btn {
      padding: 8px 16px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: #c82333;
      transform: translateY(-1px);
    }

    /* Action buttons */
    .action-buttons {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }

    /* Table section */
    .table-section {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    th {
      padding: 18px 16px;
      text-align: left;
      font-weight: 600;
      color: white;
      font-size: 15px;
      letter-spacing: 0.3px;
      border: none;
    }

    th:nth-child(3),
    th:nth-child(4),
    th:nth-child(5),
    td:nth-child(3),
    td:nth-child(4),
    td:nth-child(5) {
      text-align: center;
    }

    tbody tr {
      transition: all 0.2s ease;
      border-bottom: 1px solid #f0f0f0;
    }

    tbody tr:hover {
      background-color: #f8f9fa;
    }

    tbody tr:last-child {
      border-bottom: none;
    }

    td {
      padding: 16px;
      color: #495057;
      font-size: 15px;
      vertical-align: middle;
    }

    td[contenteditable] {
      background-color: #f8f9fa;
      cursor: text;
      border-radius: 6px;
      transition: all 0.2s ease;
    }

    td[contenteditable]:hover {
      background-color: #e9ecef;
    }

    td[contenteditable]:focus {
      outline: 2px solid #667eea;
      outline-offset: -2px;
      background-color: white;
    }

    /* Duplicate styling */
    .duplicate-number {
      color: #dc3545;
      font-weight: 600;
    }

    .duplicate-name {
      color: #ff6b6b;
      font-weight: 600;
    }

    .status-badges {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }

    .status-badge.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .status-badge.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .delete-btn {
      padding: 8px 16px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .delete-btn:hover {
      background: #c82333;
      transform: scale(1.05);
    }

    /* Stats section */
    .stats-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    .stat-icon {
      font-size: 36px;
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #6c757d;
      font-size: 14px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        align-items: flex-start;
      }

      .table-section {
        padding: 20px;
      }

      table {
        font-size: 14px;
      }

      th, td {
        padding: 12px 8px;
      }

      .status-badges {
        align-items: flex-start;
      }

      .stats-section {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .stats-section {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <!-- Loading state -->
  <div class="loading-container" id="loadingContainer">
    <div class="loading-spinner"></div>
    <div class="loading-text">è¼‰å…¥ä¸­...</div>
  </div>

  <!-- Main content -->
  <div class="container" id="mainContainer">
    <!-- Header -->
    <div class="admin-header">
      <div class="header-content">
        <div class="header-title">
          <h1>ğŸ€ è±ç‰çƒè¡£ç™»è¨˜ç®¡ç†é¢æ¿</h1>
        </div>
        <div class="action-buttons">
          <a href="toyotama.html" class="btn btn-primary">
            <span>ğŸ </span>
            <span>è¿”å›é¦–é </span>
          </a>
          <button id="exportBtn" class="btn btn-success">
            <span>ğŸ“¥</span>
            <span>åŒ¯å‡º Excel</span>
          </button>
        </div>
      </div>
      <div class="user-info" style="margin-top: 15px;">
        <span>ç›®å‰ç™»å…¥ï¼š</span>
        <span class="user-email" id="userEmail">-</span>
        <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
      </div>
    </div>

    <!-- Statistics -->
    <div class="stats-section" id="statsSection">
      <div class="stat-card">
        <div class="stat-icon">ğŸ‘•</div>
        <div class="stat-value" id="totalCount">0</div>
        <div class="stat-label">ç¸½ç™»è¨˜æ•¸é‡</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ”¢</div>
        <div class="stat-value" id="numberDuplicateCount">0</div>
        <div class="stat-label">è™Ÿç¢¼é‡è¤‡</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-value" id="nameDuplicateCount">0</div>
        <div class="stat-label">å§“åé‡è¤‡</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ“Š</div>
        <div class="stat-value" id="sizeCount">0</div>
        <div class="stat-label">å°ºå¯¸ç¨®é¡</div>
      </div>
    </div>

    <!-- Table -->
    <div class="table-section">
      <h2 style="margin: 0 0 20px 0; color: #2c3e50;">ğŸ“‹ çƒè¡£ç™»è¨˜æ¸…å–®</h2>
      <table id="adminTable">
        <thead>
          <tr>
            <th>çƒå“¡å§“å</th>
            <th>å°ºå¯¸</th>
            <th>çƒè¡£è™Ÿç¢¼</th>
            <th>ç‹€æ…‹</th>
            <th>ç™»è¨˜æ™‚é–“</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          <!-- Data will go here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- SheetJS library for Excel export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      remove,
      update
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCGCaWivohAhxZDkKp7YGNp9deNetR3K4Y",
      authDomain: "jersey-app-bcefa.firebaseapp.com",
      databaseURL: "https://jersey-app-bcefa-default-rtdb.firebaseio.com",
      projectId: "jersey-app-bcefa",
      storageBucket: "jersey-app-bcefa.appspot.com",
      messagingSenderId: "778327507472",
      appId: "1:778327507472:web:057e3db1b767f0b137c095"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // ä½¿ç”¨è±ç‰éšŠçš„å°ˆå±¬è·¯å¾‘
    const TEAM_DB_PATH = 'toyotama-jerseys';

    const tableBody = document.querySelector('#adminTable tbody');
    const loadingContainer = document.getElementById('loadingContainer');
    const mainContainer = document.getElementById('mainContainer');
    let currentData = []; // Store current data for export

    // Make logout function available globally
    window.logout = async function() {
      if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
        try {
          await signOut(auth);
          window.location.href = 'toyotama.html';
        } catch (error) {
          console.error('ç™»å‡ºéŒ¯èª¤:', error);
          alert('ç™»å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦');
        }
      }
    };

    // Check authentication state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User is signed in
        document.getElementById('userEmail').textContent = user.email;
        loadingContainer.style.display = 'none';
        mainContainer.classList.add('show');
      } else {
        // User is signed out - redirect to login
        alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡å¸³è™Ÿ');
        window.location.href = 'toyotama.html';
      }
    });

    // Listen for data changes
    onValue(ref(db, TEAM_DB_PATH), (snapshot) => {
      const data = snapshot.val();
      tableBody.innerHTML = '';
      currentData = []; // Reset current data

      if (!data) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 40px; color: #6c757d;">
              ç›®å‰æ²’æœ‰ä»»ä½•ç™»è¨˜è³‡æ–™
            </td>
          </tr>
        `;
        updateStats(0, 0, 0, 0);
        return;
      }

      const entries = Object.entries(data);

      // Count duplicates and sizes
      const numberCount = {};
      const nameCount = {};
      const sizeSet = new Set();
      let numberDuplicateEntries = 0;
      let nameDuplicateEntries = 0;

      // First pass: count occurrences
      for (const [id, entry] of entries) {
        const num = entry.jerseyNumber;
        const name = entry.name.trim().toLowerCase();
        numberCount[num] = (numberCount[num] || 0) + 1;
        nameCount[name] = (nameCount[name] || 0) + 1;
        sizeSet.add(entry.size);
      }

      // Count entries with duplicates
      const numberDuplicates = new Set();
      const nameDuplicates = new Set();
      
      for (const [id, entry] of entries) {
        if (numberCount[entry.jerseyNumber] > 1) {
          numberDuplicates.add(entry.jerseyNumber);
        }
        if (nameCount[entry.name.trim().toLowerCase()] > 1) {
          nameDuplicates.add(entry.name.trim().toLowerCase());
        }
      }

      // Custom sorting: "00" first, then "0", then numeric order
      entries.sort((a, b) => {
        const numA = a[1].jerseyNumber;
        const numB = b[1].jerseyNumber;
        
        // "00" comes first
        if (numA === "00" && numB !== "00") return -1;
        if (numA !== "00" && numB === "00") return 1;
        
        // "0" comes second
        if (numA === "0" && numB !== "0" && numB !== "00") return -1;
        if (numA !== "0" && numA !== "00" && numB === "0") return 1;
        
        // For all other numbers, sort numerically
        return parseInt(numA) - parseInt(numB);
      });

      for (const [id, entry] of entries) {
        const row = document.createElement('tr');
        const nameKey = entry.name.trim().toLowerCase();
        const isNumberDuplicate = numberCount[entry.jerseyNumber] > 1;
        const isNameDuplicate = nameCount[nameKey] > 1;

        // Prepare data for export
        const statusText = [];
        if (isNumberDuplicate) statusText.push('è™Ÿç¢¼é‡è¤‡');
        if (isNameDuplicate) statusText.push('å§“åé‡è¤‡');
        
        const exportRowData = {
          'çƒå“¡å§“å': entry.name,
          'å°ºå¯¸': entry.size,
          'çƒè¡£è™Ÿç¢¼': entry.jerseyNumber,
          'ç‹€æ…‹': statusText.length > 0 ? statusText.join('ã€') : 'æ­£å¸¸',
          'ç™»è¨˜æ™‚é–“': ''
        };

        // Editable Player Name
        const nameCell = document.createElement('td');
        nameCell.contentEditable = true;
        nameCell.textContent = entry.name;
        if (isNameDuplicate) {
          nameCell.classList.add('duplicate-name');
        }
        nameCell.addEventListener('blur', () => {
          const newName = nameCell.textContent.trim();
          if (newName) {
            update(ref(db, `${TEAM_DB_PATH}/${id}`), { name: newName });
          } else {
            nameCell.textContent = entry.name; // Restore original if empty
          }
        });
        nameCell.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            nameCell.blur();
          }
        });
        row.appendChild(nameCell);

        // Editable Size
        const sizeCell = document.createElement('td');
        sizeCell.contentEditable = true;
        sizeCell.textContent = entry.size;
        sizeCell.addEventListener('blur', () => {
          const newSize = sizeCell.textContent.trim();
          if (newSize) {
            update(ref(db, `${TEAM_DB_PATH}/${id}`), { size: newSize });
          } else {
            sizeCell.textContent = entry.size; // Restore original if empty
          }
        });
        sizeCell.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            sizeCell.blur();
          }
        });
        row.appendChild(sizeCell);

        // Editable Jersey Number
        const numberCell = document.createElement('td');
        numberCell.contentEditable = true;
        numberCell.textContent = entry.jerseyNumber;
        if (isNumberDuplicate) {
          numberCell.classList.add('duplicate-number');
        }
        numberCell.addEventListener('blur', () => {
          const newNumber = numberCell.textContent.trim();
          if (newNumber && /^(0|00|[1-9][0-9]?)$/.test(newNumber)) {
            update(ref(db, `${TEAM_DB_PATH}/${id}`), { jerseyNumber: newNumber });
          } else {
            numberCell.textContent = entry.jerseyNumber; // Restore original if invalid
            if (newNumber) {
              alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„è™Ÿç¢¼ (0, 00, æˆ– 1-99)');
            }
          }
        });
        numberCell.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            numberCell.blur();
          }
        });
        row.appendChild(numberCell);

        // Status (not editable)
        const statusCell = document.createElement('td');
        const statusBadges = document.createElement('div');
        statusBadges.className = 'status-badges';
        
        if (isNumberDuplicate && isNameDuplicate) {
          statusBadges.innerHTML = `
            <span class="status-badge warning">âš ï¸ è™Ÿç¢¼é‡è¤‡</span>
            <span class="status-badge warning">âš ï¸ å§“åé‡è¤‡</span>
          `;
        } else if (isNumberDuplicate) {
          statusBadges.innerHTML = '<span class="status-badge warning">âš ï¸ è™Ÿç¢¼é‡è¤‡</span>';
        } else if (isNameDuplicate) {
          statusBadges.innerHTML = '<span class="status-badge warning">âš ï¸ å§“åé‡è¤‡</span>';
        } else {
          statusBadges.innerHTML = '<span class="status-badge success">âœ“ æ­£å¸¸</span>';
        }
        
        statusCell.appendChild(statusBadges);
        row.appendChild(statusCell);

        // Timestamp
        const timeCell = document.createElement('td');
        const date = new Date(entry.timestamp || Date.now());
        const dateOptions = { 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        };
        const fullDateTime = date.toLocaleString('zh-TW', dateOptions);
        timeCell.textContent = fullDateTime;
        exportRowData['ç™»è¨˜æ™‚é–“'] = fullDateTime;
        row.appendChild(timeCell);

        // Delete Button
        const deleteCell = document.createElement('td');
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = "åˆªé™¤";
        deleteBtn.onclick = () => {
          if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${entry.name} çš„ç™»è¨˜è³‡æ–™å—ï¼Ÿ`)) {
            remove(ref(db, `${TEAM_DB_PATH}/${id}`));
          }
        };
        deleteCell.appendChild(deleteBtn);
        row.appendChild(deleteCell);

        tableBody.appendChild(row);
        currentData.push(exportRowData);
      }

      // Update statistics
      updateStats(entries.length, numberDuplicates.size, nameDuplicates.size, sizeSet.size);
    });

    // Update statistics display
    function updateStats(total, numberDuplicates, nameDuplicates, sizes) {
      document.getElementById('totalCount').textContent = total;
      document.getElementById('numberDuplicateCount').textContent = numberDuplicates;
      document.getElementById('nameDuplicateCount').textContent = nameDuplicates;
      document.getElementById('sizeCount').textContent = sizes;
    }

    // Export to Excel functionality
    document.getElementById('exportBtn').addEventListener('click', () => {
      if (currentData.length === 0) {
        alert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºï¼');
        return;
      }

      // Create a new workbook
      const wb = XLSX.utils.book_new();
      
      // Add summary sheet
      const summaryData = [
        ['è±ç‰ çƒè¡£ç™»è¨˜çµ±è¨ˆå ±è¡¨'],
        [''],
        ['åŒ¯å‡ºæ—¥æœŸ', new Date().toLocaleString('zh-TW')],
        ['ç¸½ç™»è¨˜æ•¸é‡', currentData.length],
        [''],
        ['é‡è¤‡ç‹€æ³çµ±è¨ˆ'],
        ['è™Ÿç¢¼é‡è¤‡æ•¸', document.getElementById('numberDuplicateCount').textContent],
        ['å§“åé‡è¤‡æ•¸', document.getElementById('nameDuplicateCount').textContent],
        [''],
        ['å°ºå¯¸åˆ†ä½ˆ'],
      ];

      // Calculate size distribution
      const sizeDistribution = {};
      currentData.forEach(row => {
        const size = row['å°ºå¯¸'];
        sizeDistribution[size] = (sizeDistribution[size] || 0) + 1;
      });

      Object.entries(sizeDistribution).forEach(([size, count]) => {
        summaryData.push([size, count]);
      });

      const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, summarySheet, "çµ±è¨ˆæ‘˜è¦");
      
      // Convert data to worksheet
      const ws = XLSX.utils.json_to_sheet(currentData);
      
      // Add worksheet to workbook
      XLSX.utils.book_append_sheet(wb, ws, "çƒè¡£ç™»è¨˜æ¸…å–®");
      
      // Generate filename with current date
      const date = new Date();
      const dateStr = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
      const filename = `è±ç‰çƒè¡£ç™»è¨˜_${dateStr}.xlsx`;
      
      // Save the file
      XLSX.writeFile(wb, filename);
    });
  </script>
</body>
</html>